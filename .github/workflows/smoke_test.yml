name: Smoke test staging
on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"
  pull_request:
    paths:
      - api/**
      - .github/workflows/smoke_test.yml

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Smoke test
        run: |
          response=$(curl -X POST https://url-shortener.cdssandbox.xyz/v1 \
                  -H "Content-Type: application/json" \
                  -H "Authorization: Bearer ${{secrets.STAGING_AUTH_TOKEN_APP}}" \
                  -d '{"url": "https://digital.canada.ca?time=`date +%s`"}' | jq -r '.short_url')
          echo $response        

          if [[ $response =~ ^https://url-shortener.cdssandbox.xyz/[a-zA-Z0-9]{8}$ ]]; then
              echo "Looking for https://digital.canada.ca in $response"
              if curl -s $response | grep -q "https://digital.canada.ca"; then
                  echo "Smoke test passed"
              else
                  echo "Smoke test failed"
                  exit 1
              fi
          else
              echo "Smoke test failed"
              exit 1
          fi
